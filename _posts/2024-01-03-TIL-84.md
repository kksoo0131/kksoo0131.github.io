---
layout: post
title:  "C# async-await, Task"
date:   2024-01-03
excerpt: ".NET의 Task 기반 비동기 패턴 TAP"
tag:
- TIL
- C#
- .Net
- TAP
- Task
- async-await

comments: true
---

![nbcbanner](/assets/img/TILbanner.png)


<br/>
<br/>


# 작업 기반 비동기 패턴 TAP(Task-based Asynchronous Pattern)

Task 클래스를 사용해 비동기 작업을 통제하는 패턴으로 async-await, Task를 사용해 바동기 프로그래밍을 단순화 합니다.

<br/>
<br/>

## Task 클래스

비동기 작업의 결과를 나타냅니다, 작업이 완료되기를 기다리거나 작업의 결과를 받아올 수 있습니다.

<br/>

### TaskScheduler

.NET의 TaskScheduler 클래스를 통해 Task의 실행을 관리합니다.

Task가 실행될 스레드를 결정하고 Task들의 우선순위를 조정합니다.

기본적으로 ThreadPool을 사용하여 Task들을 실행합니다.

<br/>

### ThreadPool

스레드를 효율적으로 관리하며, 스레드의 생성 및 소멸에 따른 오버헤드를 줄여줍니다.

개발자가 ThreadPool 관리에 대해 걱정할 필요 없이 비동기 작업을 쉽게 구현할 수 있습니다.

<br/>

### 정리

개발자는 Task API를 사용하여 비동기 작업을 쉽게 정의하고 실행할 수 있으며

내부적으로 TaskScheduler와 ThreadPool를 통해서 작업을 처리합니다.


<br/>
<br/>

## async 키워드

C#에서 비동기 메서드를 선언할 떄 사용됩니다.

이 키워드를 사용한 메서드가 호출되면 즉시 Task를 반환합니다.

메서드 내부에서 await 키워드를 사용해 비동기 작업을 간결하게 표현할 수 있습니다.

### async void

async void 는 Task를 반환하지 않기 때문에 TaskSchedular로 추적, 관리할 수 없습니다. 

호출된 시점의 `동기화 컨텍스트`에서 작업을 바로 시작하게됩니다.

추적, 관리할 수 없고 예외 처리가 어렵기 때문에 void 반환이 요구되는 이벤트 핸들러에서 주로 사용되고 일반적으로는 사용을 지양합니다.

### 동기화 컨텍스트 (Synchronization Context)

비동기 작업이 완료된 후 결과를 어떤 컨텍스트(스레드)에서 처리할 지 관리하는 메커니즘

비동기 작업의 완료후 돌아가게될 스레드를 결정합니다.

<br/>
<br/>

## await 키워드

async 메서드 내부에서 사용됩니다. Task의 완료를 비동기적으로 기다립니다.

해당 Task가 완료될 때까지 현재 async 메서드를 일시 중단하고 TaskScheduler에 의해 대기 상태로 관리됩니다.

Task가 완료되면 현재 async 메서드가 TaskScheduler에 의해 활성 상태가 되고 중단된 지점부터 실행을 재개합니다.


## 코루틴과의 차이점은? 유니티 상에서 사용할떄 주의할점?

TAP방식은 하나의 스레드에게 작업을 맡겨서 작업의 완료를 추적하는 방식이고

Unity 코루틴은 C# 언어 자체의 기능이 아닙니다.
메서드를 중단,재개할수 있는 기능을 통해 특정 스레드에 국한 되지 않고 작업을 진행합니다.

스레드 종속성에서 큰 차이가 있습니다.

## 스레드 종속성의 차이??

TAP 방식은 스레드 풀에 6개의 스레드가 있고 10개의 비동기 작업이 주어졌을때

6개의 작업이 먼저 스레드에 할당되고 스레드 풀에 대기중인 스레드가 생길때 마다 나머지 작업을 할당하게 됩니다.

코루틴 방식은 스레드의 수와는 상관없이 10개의 코루틴을 유연하게 실행하게 됩니다. 
![nbcthumbnail](/assets/img/thumbnail-image.png)